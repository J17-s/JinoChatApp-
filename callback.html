<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jino Chat - Ë™çË®º‰∏≠...</title>
    <style>
        body {
            background-color: #1a1a2e;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            font-family: sans-serif;
        }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        #log {
            margin-top: 20px;
            font-family: monospace;
            font-size: 12px;
            color: #888;
            text-align: left;
            width: 80%;
        }
    </style>
</head>

<body>
    <div class="loader"></div>
    <p id="status">„Ç∑„Çπ„ÉÜ„É†„ÇíËµ∑Âãï„Åó„Å¶„ÅÑ„Åæ„Åô...</p>
    <div id="log"></div>
    <button id="retry" style="display:none; margin-top:20px; padding:10px 20px; cursor:pointer;"
        onclick="location.reload()">ÂÜçË©¶Ë°å</button>
    <button id="go-home" style="display:none; margin-top:10px; padding:10px 20px; cursor:pointer;"
        onclick="location.href='index.html'">„É°„Ç§„É≥„Å∏ÁßªÂãï</button>

    <!-- Load Supabase from a reliable CDN with onload handler -->
    <script src="https://unpkg.com/@supabase/supabase-js@2" onload="initAuth()" onerror="loadError()"></script>

    <script>
        function log(msg) {
            const el = document.getElementById('log');
            if (el) el.innerHTML += `<div>${msg}</div>`;
            console.log(msg);
        }

        function loadError() {
            document.getElementById('status').innerText = '‚ö†Ô∏è „Ç∑„Çπ„ÉÜ„É†„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ';
            document.getElementById('retry').style.display = 'block';
        }

        async function initAuth() {
            log("üìö Library loaded. Initializing...");
            document.getElementById('status').innerText = 'Ë™çË®ºÊÉÖÂ†±„ÇíÁ¢∫Ë™ç„Åó„Å¶„ÅÑ„Åæ„Åô...';

            // Show manual buttons after 3 seconds safety timer
            setTimeout(() => {
                document.getElementById('go-home').style.display = 'block';
            }, 3000);

            try {
                const SUPABASE_URL = 'https://njvarmfkytofbboqjgeu.supabase.co';
                const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5qdmFybWZreXRvZmJib3FqZ2V1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzY3ODI4NDUsImV4cCI6MjA1MjM1ODg0NX0.sb_publishable_jjKlMTBb7xXxp6eX4E0yoQ_-I1fGjHU';

                // Initialize
                const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
                    auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
                });

                log("üîÑ Checking session...");

                // 1. Check URL Hash
                if (window.location.hash) log("üì¶ Hash found!");

                // 2. Try to get session
                const { data, error } = await supabase.auth.getSession();

                if (data?.session) {
                    log("üéâ OK! Logged in as: " + data.session.user.email);

                    // Whitelist check
                    if (data.session.user.email === '321mugen@gmail.com') {
                        log("‚úÖ Access Granted. Redirecting...");
                        window.location.href = 'index.html';
                    } else {
                        log("üö´ Access Denied.");
                        await supabase.auth.signOut();
                        alert("Ë®±ÂèØ„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑ„Ç¢„Ç´„Ç¶„É≥„Éà„Åß„Åô„ÄÇ");
                        window.location.href = 'login.html';
                    }
                } else {
                    log("‚è≥ Waiting for auth event...");
                    supabase.auth.onAuthStateChange((event, session) => {
                        log("üì° Event: " + event);
                        if (session) {
                            if (session.user.email === '321mugen@gmail.com') {
                                window.location.href = 'index.html';
                            }
                        }
                    });
                }

            } catch (e) {
                log("‚ùå Error: " + e.message);
            }
        }
    </script>
</body>

</html>