<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jino Chat - èªè¨¼ä¸­...</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: #1a1a2e;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            font-family: 'Inter', sans-serif;
            text-align: center;
        }

        .auth-card {
            max-width: 400px;
            width: 90%;
            padding: 40px 30px;
        }

        .loader {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid #a78bfa;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 24px;
        }

        .loader.error {
            border-top-color: #ff4757;
            animation: none;
        }

        .loader.success {
            border-top-color: #10b981;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        #status {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 8px;
            color: #e0e0e0;
        }

        #sub-status {
            font-size: 14px;
            color: #888;
            margin-bottom: 20px;
        }

        #log {
            font-family: 'Courier New', monospace;
            font-size: 11px;
            color: #555;
            max-width: 100%;
            word-break: break-all;
            margin-top: 20px;
            line-height: 1.6;
            text-align: left;
        }

        .btn {
            display: inline-block;
            padding: 12px 28px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            font-size: 14px;
            margin-top: 12px;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #a78bfa, #7c3aed);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(167, 139, 250, 0.4);
        }

        .btn-outline {
            background: transparent;
            border: 1px solid #444;
            color: #aaa;
        }

        .btn-outline:hover {
            border-color: #888;
            color: #fff;
        }

        #controls {
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            margin-top: 16px;
        }

        .unauthorized-msg {
            background: rgba(255, 71, 87, 0.1);
            border: 1px solid rgba(255, 71, 87, 0.3);
            border-radius: 12px;
            padding: 16px 20px;
            margin-top: 16px;
            color: #ff6b7a;
            font-size: 14px;
            line-height: 1.6;
        }
    </style>
</head>

<body>
    <div class="auth-card">
        <div class="loader" id="spinner"></div>
        <div id="status">èªè¨¼ä¸­...</div>
        <div id="sub-status">Google ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ç¢ºèªã—ã¦ã„ã¾ã™</div>
        <div id="unauthorized-area"></div>
        <div id="controls">
            <a class="btn btn-outline" href="login.html">ãƒ­ã‚°ã‚¤ãƒ³ã¸æˆ»ã‚‹</a>
        </div>
        <div id="log"></div>
    </div>

    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- å…±é€šè¨­å®š (SUPABASE_URL, SUPABASE_ANON_KEY, ALLOWED_EMAILS, supabaseClient) -->
    <script src="js/config/supabase.js?v=6"></script>

    <script>
        const statusEl = document.getElementById('status');
        const subStatusEl = document.getElementById('sub-status');
        const logEl = document.getElementById('log');
        const controls = document.getElementById('controls');
        const spinner = document.getElementById('spinner');
        const unauthorizedArea = document.getElementById('unauthorized-area');

        function log(msg) {
            console.log('[callback]', msg);
            logEl.innerHTML += `<div>[${new Date().toLocaleTimeString()}] ${msg}</div>`;
        }

        function showError(title, subtitle) {
            statusEl.textContent = title;
            subStatusEl.textContent = subtitle || '';
            spinner.classList.add('error');
            controls.style.display = 'flex';
        }

        function showSuccess(title, subtitle) {
            statusEl.textContent = title;
            subStatusEl.textContent = subtitle || '';
            spinner.classList.add('success');
        }

        async function processCallback() {
            log("ğŸš€ èªè¨¼ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–‹å§‹...");

            // Safety timer: 8ç§’å¾Œã«ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’è¡¨ç¤º
            const safetyTimer = setTimeout(() => {
                controls.style.display = 'flex';
                log("ğŸ•’ å®‰å…¨ã‚¿ã‚¤ãƒãƒ¼ç™ºå‹•ã€‚ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’è¡¨ç¤ºã€‚");
            }, 8000);

            try {
                // ===================================
                // Step 1: ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®å–å¾—
                // ===================================

                let session = null;

                // â‘  PKCE ãƒ•ãƒ­ãƒ¼: URLã« ?code= ãŒã‚ã‚‹å ´åˆ
                const urlParams = new URLSearchParams(window.location.search);
                const code = urlParams.get('code');

                if (code) {
                    log("ğŸ” PKCE code æ¤œå‡º...");
                    statusEl.textContent = 'ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ç¢ºç«‹ä¸­...';

                    const { data, error } = await supabaseClient.auth.exchangeCodeForSession(code);

                    if (error) {
                        log("âŒ PKCE ã‚¨ãƒ©ãƒ¼: " + error.message);
                        showError('èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ', 'ã‚‚ã†ä¸€åº¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„');
                        clearTimeout(safetyTimer);
                        return;
                    }

                    if (data?.session) {
                        session = data.session;
                        log("âœ… PKCE ã‚»ãƒƒã‚·ãƒ§ãƒ³ç¢ºç«‹: " + session.user.email);
                    }

                    // URLã‹ã‚‰codeã‚’æ¶ˆã™
                    window.history.replaceState({}, document.title, window.location.pathname);
                }

                // â‘¡ Implicit ãƒ•ãƒ­ãƒ¼: ãƒãƒƒã‚·ãƒ¥ã« access_token ãŒã‚ã‚‹å ´åˆ
                if (!session && window.location.hash.includes('access_token')) {
                    log("ğŸ” Implicit ãƒˆãƒ¼ã‚¯ãƒ³æ¤œå‡º...");
                    statusEl.textContent = 'ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ç¢ºç«‹ä¸­...';

                    // Supabase SDK ãŒè‡ªå‹•çš„ã«ãƒãƒƒã‚·ãƒ¥ã‹ã‚‰ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å¾©å…ƒã™ã‚‹ã®ã‚’å¾…ã¤
                    await new Promise(resolve => setTimeout(resolve, 500));

                    const { data: { session: hashSession }, error } = await supabaseClient.auth.getSession();

                    if (error) {
                        log("âŒ Implicit ã‚¨ãƒ©ãƒ¼: " + error.message);
                        showError('èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ', 'ã‚‚ã†ä¸€åº¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„');
                        clearTimeout(safetyTimer);
                        return;
                    }

                    if (hashSession) {
                        session = hashSession;
                        log("âœ… Implicit ã‚»ãƒƒã‚·ãƒ§ãƒ³ç¢ºç«‹: " + session.user.email);
                    }

                    // URLã‹ã‚‰ãƒãƒƒã‚·ãƒ¥ã‚’æ¶ˆã™
                    window.history.replaceState({}, document.title, window.location.pathname);
                }

                // â‘¢ æ—¢å­˜ã‚»ãƒƒã‚·ãƒ§ãƒ³ç¢ºèª
                if (!session) {
                    log("â³ æ—¢å­˜ã‚»ãƒƒã‚·ãƒ§ãƒ³ç¢ºèªä¸­...");
                    const { data } = await supabaseClient.auth.getSession();
                    session = data.session;

                    if (session) {
                        log("âœ… æ—¢å­˜ã‚»ãƒƒã‚·ãƒ§ãƒ³ç™ºè¦‹: " + session.user.email);
                    }
                }

                // â‘£ ãã‚Œã§ã‚‚ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒç„¡ã„å ´åˆ â†’ onAuthStateChange ã§å¾…ã¤
                if (!session) {
                    log("â³ ã‚»ãƒƒã‚·ãƒ§ãƒ³å¾…æ©Ÿä¸­...");
                    statusEl.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³ä¸­...';
                    subStatusEl.textContent = 'ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å¾…ã£ã¦ã„ã¾ã™...';

                    session = await new Promise((resolve, reject) => {
                        const timeout = setTimeout(() => {
                            reject(new Error('ã‚»ãƒƒã‚·ãƒ§ãƒ³å–å¾—ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ'));
                        }, 10000);

                        supabaseClient.auth.onAuthStateChange((event, newSession) => {
                            log("ğŸ”” Auth Event: " + event);
                            if (newSession) {
                                clearTimeout(timeout);
                                resolve(newSession);
                            }
                        });
                    });
                }

                // ===================================
                // Step 2: ãƒ¡ãƒ¼ãƒ«ã®ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆãƒã‚§ãƒƒã‚¯
                // ===================================
                const userEmail = session.user.email.toLowerCase();
                log("ğŸ“§ ãƒ¡ãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯: " + userEmail);

                const isAllowed = ALLOWED_EMAILS.some(e => e.toLowerCase() === userEmail);

                if (isAllowed) {
                    // âœ… è¨±å¯ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼
                    log("âœ… ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯: " + userEmail);
                    showSuccess('ãŠã‹ãˆã‚Šã€ãƒ¦ã‚¦ã‚«ï¼', 'ã‚¢ãƒ—ãƒªã«æ¥ç¶šä¸­...');
                    clearTimeout(safetyTimer);

                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 800);
                } else {
                    // ğŸš« è¨±å¯ã•ã‚Œã¦ã„ãªã„ãƒ¦ãƒ¼ã‚¶ãƒ¼
                    log("ğŸš« ã‚¢ã‚¯ã‚»ã‚¹æ‹’å¦: " + userEmail);

                    // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ç ´æ£„
                    await supabaseClient.auth.signOut();
                    log("ğŸ”“ ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ç ´æ£„ã—ã¾ã—ãŸ");

                    showError('ã‚¢ã‚¯ã‚»ã‚¹ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“', '');
                    unauthorizedArea.innerHTML = `
                        <div class="unauthorized-msg">
                            <strong>ã“ã®ã‚¢ãƒ—ãƒªã¯ Yuuka å°‚ç”¨ã§ã™ã€‚</strong><br>
                            ãƒ­ã‚°ã‚¤ãƒ³ã—ãŸã‚¢ã‚«ã‚¦ãƒ³ãƒˆ (${userEmail}) ã«ã¯ã‚¢ã‚¯ã‚»ã‚¹æ¨©ãŒã‚ã‚Šã¾ã›ã‚“ã€‚
                        </div>
                    `;
                    clearTimeout(safetyTimer);
                    controls.style.display = 'flex';
                }

            } catch (err) {
                log("ğŸš¨ ã‚¨ãƒ©ãƒ¼: " + err.message);
                showError('èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ', err.message);
                clearTimeout(safetyTimer);
            }
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å¾Œã«å®Ÿè¡Œ
        window.addEventListener('load', processCallback);
    </script>
</body>

</html>