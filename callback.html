<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jino Chat - Ë™çË®º‰∏≠...</title>
    <style>
        body {
            background-color: #1a1a2e;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            font-family: 'Helvetica Neue', Arial, sans-serif;
        }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
    <div class="loader"></div>
    <p>Ë™çË®º‰∏≠... „Ç∏„Éé„Å®„ÅÆÊé•Á∂ö„ÇíÁ¢∫Á´ã„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ</p>
    <div id="debug-log"
        style="margin-top: 20px; font-size: 12px; color: #888; font-family: monospace; max-width: 80%; word-break: break-all;">
    </div>
    <button id="manual-proceed"
        style="display: none; margin-top: 20px; padding: 10px 20px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer;">
        „É°„Ç§„É≥„Éö„Éº„Ç∏„Å∏Âº∑Âà∂ÁßªÂãï
    </button>

    <script>
        const logDiv = document.getElementById('debug-log');
        function log(msg) {
            console.log(msg);
            logDiv.innerHTML += `<div>${msg}</div>`;
        }

        // Supabase Configuration
        const SUPABASE_URL = 'https://njvarmfkytofbboqjgeu.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5qdmFybWZreXRvZmJib3FqZ2V1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzY3ODI4NDUsImV4cCI6MjA1MjM1ODg0NX0.sb_publishable_jjKlMTBb7xXxp6eX4E0yoQ_-I1fGjHU';
        const ALLOWED_EMAILS = ['321mugen@gmail.com'];

        // Initialize Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
            auth: {
                persistSession: true,
                autoRefreshToken: true,
                detectSessionInUrl: true
            }
        });

        async function handleCallback() {
            log("üöÄ Callback initialization started...");

            // Show manual proceed button after 5 seconds just in case
            setTimeout(() => {
                const btn = document.getElementById('manual-proceed');
                btn.style.display = 'block';
                btn.onclick = () => window.location.href = 'index.html';
                log("‚ö†Ô∏è Timeout: Showing manual proceed button");
            }, 5000);

            try {
                // Check URL Hash first
                if (window.location.hash) {
                    log("üì¶ Hash found in URL: " + window.location.hash.substring(0, 50) + "...");
                } else {
                    log("‚ùå No hash found in URL!");
                }

                // Wait for session
                const { data, error } = await supabase.auth.getSession();

                if (error) {
                    log("‚ùå getSession Error: " + error.message);
                    throw error;
                }

                if (data.session) {
                    log("üéâ Session found immediately!");
                    validateAndRedirect(data.session);
                    return;
                }

                log("‚è≥ Waiting for onAuthStateChange...");

                // Set up listener
                const { data: { subscription } } = supabase.auth.onAuthStateChange(async (event, session) => {
                    log(`üì° Auth Event: ${event}`);
                    if (session) {
                        log("üéâ Session established via event!");
                        validateAndRedirect(session);
                        subscription.unsubscribe();
                    }
                });

            } catch (err) {
                console.error('Callback error:', err);
                showFailure("Ë™çË®º„Ç®„É©„Éº: " + err.message);
            }
        }

        async function validateAndRedirect(session) {
            const userEmail = session.user.email.toLowerCase();
            log(`üìß Checking email: ${userEmail}`);

            const isAllowed = ALLOWED_EMAILS.some(email => email.toLowerCase() === userEmail);

            if (!isAllowed) {
                log("üö´ Email not allowed");
                await supabase.auth.signOut();
                showFailure(`„Ç¢„Ç´„Ç¶„É≥„Éà (${userEmail}) „ÅØË®±ÂèØ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ`);
                return;
            }

            log("‚úÖ Validation successful! Redirecting...");
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 500);
        }

        function showFailure(message) {
            document.querySelector('.loader').style.display = 'none';
            const p = document.querySelector('p');
            p.innerHTML = `<span style="color: #ff6b6b">‚ö†Ô∏è „Ç®„É©„Éº: ${message}</span><br><br><a href="login.html" style="color: white">„É≠„Ç∞„Ç§„É≥ÁîªÈù¢„Å´Êàª„Çã</a>`;
        }

        handleCallback();
    </script>
</body>

</html>